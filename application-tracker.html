<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My University Applications | University Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        .app-nav {
            position: sticky;
            top: 0;
            z-index: 50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        .app-nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
        }
        .app-nav a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .app-nav a.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        /* Sticky controls bar */
        .sticky-controls {
            position: sticky;
            top: 48px;
            z-index: 40;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 12px 20px;
        }

        /* Compact stats */
        .stat-inline {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-right: 16px;
            font-size: 0.875rem;
        }
        .stat-number {
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Compact table */
        table {
            font-size: 0.875rem;
        }
        th {
            padding: 8px 6px !important;
            font-size: 0.75rem;
            font-weight: 600;
        }
        td {
            padding: 6px !important;
            vertical-align: top;
        }

        /* Status dropdown styling */
        .status-select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 100px;
        }
        .status-select.Planning { background: #e0e7ff; color: #4338ca; }
        .status-select.Applied { background: #dbeafe; color: #1e40af; }
        .status-select.Pending { background: #fef3c7; color: #92400e; }
        .status-select.Accepted { background: #d1fae5; color: #065f46; }
        .status-select.Rejected { background: #fee2e2; color: #991b1b; }

        /* Compact inputs */
        input[type="date"] {
            padding: 4px;
            font-size: 0.75rem;
            width: 110px;
        }
        textarea {
            font-size: 0.75rem;
            min-height: 50px;
        }

        /* Icon buttons */
        .icon-btn {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.875rem;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .icon-btn:hover {
            background: #f3f4f6;
        }

        @media print {
            .no-print { display: none; }
            .app-nav, .sticky-controls { position: static; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="app-nav no-print">
        <a href="index.html">
            üéì Universities
        </a>
        <a href="agents/financial-aid-advisor-agent/scholarship-tracker.html">
            üí∞ Scholarships
        </a>
        <a href="application-tracker.html" class="active">
            üìù My Applications
        </a>
    </nav>

    <!-- Sticky Controls Bar -->
    <div class="sticky-controls no-print">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <!-- Stats inline -->
            <div class="flex flex-wrap items-center">
                <span class="stat-inline">
                    <span class="stat-number text-purple-600" id="stat-total">0</span>
                    <span class="text-gray-600">Total</span>
                </span>
                <span class="stat-inline">
                    <span class="stat-number text-blue-600" id="stat-planning">0</span>
                    <span class="text-gray-600">Planning</span>
                </span>
                <span class="stat-inline">
                    <span class="stat-number text-yellow-600" id="stat-applied">0</span>
                    <span class="text-gray-600">Applied</span>
                </span>
                <span class="stat-inline">
                    <span class="stat-number text-green-600" id="stat-accepted">0</span>
                    <span class="text-gray-600">Accepted</span>
                </span>
                <span class="stat-inline">
                    <span class="stat-number text-red-600" id="stat-rejected">0</span>
                    <span class="text-gray-600">Rejected</span>
                </span>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2">
                <select id="filterStatus" class="px-3 py-1.5 text-sm border rounded">
                    <option value="all">All Statuses</option>
                    <option value="Planning">üìã Planning</option>
                    <option value="Applied">üì§ Applied</option>
                    <option value="Pending">‚è≥ Pending</option>
                    <option value="Accepted">‚úÖ Accepted</option>
                    <option value="Rejected">‚ùå Rejected</option>
                </select>
                <button onclick="window.print()" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                    üñ®Ô∏è Print
                </button>
                <button onclick="exportToCSV()" class="px-3 py-1.5 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                    üìä CSV
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-full px-4 py-4">
        <!-- Empty State -->
        <div id="empty-state" class="bg-white rounded-lg shadow p-8 text-center text-gray-500 hidden">
            <p class="text-lg mb-2">No universities shortlisted yet</p>
            <p class="text-sm">Go to the <a href="index.html" class="text-blue-600 underline">Universities page</a> and click "+ Shortlist" on universities you want to apply to!</p>
        </div>

        <!-- Applications Table -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full" id="applications-table" style="display: none;">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="text-left">University</th>
                        <th class="text-left">Country</th>
                        <th class="text-left">Program</th>
                        <th class="text-left">Cost</th>
                        <th class="text-left">Status</th>
                        <th class="text-left">Deadline</th>
                        <th class="text-left" style="min-width: 250px;">Notes / Next Steps</th>
                        <th class="text-center no-print" style="width: 60px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="applications-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script src="universities-data.js"></script>
    <script>
        function loadData() {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            const unis = Object.keys(applications).map(id => parseInt(id));

            if (unis.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('applications-table').style.display = 'none';
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('applications-table').style.display = 'table';

            renderApplications(applications);
        }

        function renderApplications(applications) {
            const filterStatus = document.getElementById('filterStatus').value;
            const tbody = document.getElementById('applications-tbody');
            tbody.innerHTML = '';

            let total = 0, planning = 0, applied = 0, accepted = 0, rejected = 0;

            Object.entries(applications).forEach(([uniId, appData]) => {
                const uni = UNIVERSITIES_DATA.find(u => u.id === parseInt(uniId));
                if (!uni) return;

                // Filter
                if (filterStatus !== 'all' && appData.status !== filterStatus) return;

                total++;
                if (appData.status === 'Planning') planning++;
                if (appData.status === 'Applied' || appData.status === 'Pending') applied++;
                if (appData.status === 'Accepted') accepted++;
                if (appData.status === 'Rejected') rejected++;

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td>
                        <div class="font-semibold text-gray-900">${uni.name}</div>
                        <div class="flex gap-2 mt-1">
                            <a href="${uni.url}" target="_blank" class="icon-btn text-blue-600" title="Visit Website">
                                üîó
                            </a>
                            ${uni.admissionsEmail ? `
                                <a href="mailto:${uni.admissionsEmail}" class="icon-btn text-purple-600" title="${uni.admissionsEmail}">
                                    üìß
                                </a>
                            ` : ''}
                        </div>
                    </td>
                    <td class="text-sm text-gray-700">${uni.country}</td>
                    <td class="text-sm text-gray-700">${uni.program}</td>
                    <td class="text-sm font-semibold text-gray-900">${uni.cost}</td>
                    <td>
                        <select
                            class="status-select ${appData.status}"
                            onchange="updateStatus(${uni.id}, this.value)"
                        >
                            <option value="Planning" ${appData.status === 'Planning' ? 'selected' : ''}>üìã Planning</option>
                            <option value="Applied" ${appData.status === 'Applied' ? 'selected' : ''}>üì§ Applied</option>
                            <option value="Pending" ${appData.status === 'Pending' ? 'selected' : ''}>‚è≥ Pending</option>
                            <option value="Accepted" ${appData.status === 'Accepted' ? 'selected' : ''}>‚úÖ Accepted</option>
                            <option value="Rejected" ${appData.status === 'Rejected' ? 'selected' : ''}>‚ùå Rejected</option>
                        </select>
                    </td>
                    <td>
                        <input
                            type="date"
                            value="${appData.deadline || ''}"
                            onchange="updateDeadline(${uni.id}, this.value)"
                            class="border rounded"
                        />
                    </td>
                    <td>
                        <textarea
                            onchange="updateNotes(${uni.id}, this.value)"
                            placeholder="Add notes..."
                            rows="2"
                            class="w-full px-2 py-1 border rounded resize-y"
                        >${appData.notes || ''}</textarea>
                    </td>
                    <td class="text-center no-print">
                        <button
                            onclick="removeApplication(${uni.id})"
                            class="text-red-600 hover:text-red-800 text-sm"
                            title="Remove from shortlist"
                        >
                            ‚úï
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Update stats
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-planning').textContent = planning;
            document.getElementById('stat-applied').textContent = applied;
            document.getElementById('stat-accepted').textContent = accepted;
            document.getElementById('stat-rejected').textContent = rejected;
        }

        function updateStatus(uniId, status) {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            if (applications[uniId]) {
                applications[uniId].status = status;
                localStorage.setItem('universityApplications', JSON.stringify(applications));
                loadData(); // Reload to update styling
            }
        }

        function updateDeadline(uniId, deadline) {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            if (applications[uniId]) {
                applications[uniId].deadline = deadline;
                localStorage.setItem('universityApplications', JSON.stringify(applications));
            }
        }

        function updateNotes(uniId, notes) {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            if (applications[uniId]) {
                applications[uniId].notes = notes;
                localStorage.setItem('universityApplications', JSON.stringify(applications));
            }
        }

        function removeApplication(uniId) {
            if (!confirm('Remove this university from your application tracker?')) return;

            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            delete applications[uniId];
            localStorage.setItem('universityApplications', JSON.stringify(applications));
            loadData();
        }

        function exportToCSV() {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');

            let csv = 'University,Country,Program,Total Cost,Status,Deadline,Notes,Admissions Email,Website\n';

            Object.entries(applications).forEach(([uniId, appData]) => {
                const uni = UNIVERSITIES_DATA.find(u => u.id === parseInt(uniId));
                if (!uni) return;

                csv += `"${uni.name}","${uni.country}","${uni.program}","${uni.cost}","${appData.status}","${appData.deadline || ''}","${appData.notes || ''}","${uni.admissionsEmail || ''}","${uni.url}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `university-applications-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Event listeners
        document.getElementById('filterStatus').addEventListener('change', () => {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            renderApplications(applications);
        });

        // Load data on page load
        loadData();

        // Reload when localStorage changes (from other tabs)
        window.addEventListener('storage', loadData);
    </script>
</body>
</html>
