<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My University Applications | University Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #1a1a2e;
            color: #eaeaea;
        }
        .app-nav {
            position: sticky;
            top: 0;
            z-index: 50;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid #334155;
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        .app-nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
        }
        .app-nav a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .app-nav a.active {
            background: #64ffda;
            color: #0f172a;
            font-weight: 600;
        }

        /* Sticky controls bar */
        .sticky-controls {
            position: sticky;
            top: 48px;
            z-index: 40;
            background: #16213e;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            padding: 12px 20px;
            border-bottom: 1px solid #2a3f5f;
        }

        /* Compact stats */
        .stat-inline {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-right: 16px;
            font-size: 0.875rem;
            color: #eaeaea;
        }
        .stat-number {
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Compact table */
        table {
            font-size: 0.875rem;
            background: #16213e;
        }
        th {
            position: sticky;
            top: 100px;
            z-index: 30;
            padding: 8px 6px !important;
            font-size: 0.75rem;
            font-weight: 600;
            background: #0f1626;
            color: #a8b2d1;
            border-bottom: 1px solid #2a3f5f;
            cursor: pointer;
            user-select: none;
        }
        th:hover {
            background: #1a2332;
        }
        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
        }
        th.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }
        th.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }
        td {
            padding: 6px !important;
            vertical-align: top;
            border-bottom: 1px solid #1a2332;
            color: #ccd6f6;
        }
        tr:hover td {
            background: #1a2942;
        }

        /* Country abbreviations */
        .country-abbr {
            display: inline-block;
            padding: 2px 6px;
            background: #2a3f5f;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.7rem;
            color: #64ffda;
        }

        /* Program wrapping */
        .program-text {
            max-width: 150px;
            word-wrap: break-word;
            line-height: 1.3;
        }

        /* Status dropdown styling */
        .status-select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 100px;
        }
        .status-select.Planning { background: #e0e7ff; color: #4338ca; }
        .status-select.Applied { background: #dbeafe; color: #1e40af; }
        .status-select.Pending { background: #fef3c7; color: #92400e; }
        .status-select.Accepted { background: #d1fae5; color: #065f46; }
        .status-select.Rejected { background: #fee2e2; color: #991b1b; }

        /* Compact inputs */
        input[type="date"], select, textarea {
            background: #0f1626;
            color: #eaeaea;
            border: 1px solid #2a3f5f;
        }
        input[type="date"] {
            padding: 4px;
            font-size: 0.75rem;
            width: 110px;
        }
        textarea {
            font-size: 0.75rem;
            min-height: 50px;
        }
        select {
            cursor: pointer;
        }

        /* Icon buttons */
        .icon-btn {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.875rem;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s;
            color: inherit;
        }
        .icon-btn:hover {
            background: #2a3f5f;
        }

        /* Empty state */
        .empty-state-bg {
            background: #16213e;
            border: 1px solid #2a3f5f;
            color: #a8b2d1;
        }
        .empty-state-bg a {
            color: #64ffda;
        }

        /* Table container */
        .table-container {
            background: #16213e;
            border: 1px solid #2a3f5f;
        }

        @media print {
            .no-print { display: none; }
            .app-nav, .sticky-controls { position: static; }
            body { background: white; color: black; }
            table, th, td { background: white; color: black; border-color: #ccc; }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="app-nav no-print">
        <a href="index.html">
            üéì Universities
        </a>
        <a href="agents/financial-aid-advisor-agent/scholarship-tracker.html">
            üí∞ Scholarships
        </a>
        <a href="application-tracker.html" class="active">
            üìù My Applications
        </a>
    </nav>

    <!-- Sticky Controls Bar -->
    <div class="sticky-controls no-print">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <!-- Stats inline -->
            <div class="flex flex-wrap items-center">
                <span class="stat-inline">
                    <span class="stat-number" style="color: #c792ea;" id="stat-total">0</span>
                    <span>Total</span>
                </span>
                <span class="stat-inline">
                    <span class="stat-number" style="color: #82aaff;" id="stat-planning">0</span>
                    <span>Planning</span>
                </span>
                <span class="stat-inline">
                    <span class="stat-number" style="color: #ffcb6b;" id="stat-applied">0</span>
                    <span>Applied</span>
                </span>
                <span class="stat-inline">
                    <span class="stat-number" style="color: #c3e88d;" id="stat-accepted">0</span>
                    <span>Accepted</span>
                </span>
                <span class="stat-inline">
                    <span class="stat-number" style="color: #f07178;" id="stat-rejected">0</span>
                    <span>Rejected</span>
                </span>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2">
                <select id="filterStatus" class="px-3 py-1.5 text-sm rounded" style="background: #0f1626; border: 1px solid #2a3f5f;">
                    <option value="all">All Statuses</option>
                    <option value="Planning">üìã Planning</option>
                    <option value="Applied">üì§ Applied</option>
                    <option value="Pending">‚è≥ Pending</option>
                    <option value="Accepted">‚úÖ Accepted</option>
                    <option value="Rejected">‚ùå Rejected</option>
                </select>
                <button onclick="window.print()" class="px-3 py-1.5 text-sm text-white rounded" style="background: #82aaff;">
                    üñ®Ô∏è Print
                </button>
                <button onclick="exportToCSV()" class="px-3 py-1.5 text-sm text-white rounded" style="background: #c3e88d; color: #0f1626;">
                    üìä CSV
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-full px-4 py-4">
        <!-- Empty State -->
        <div id="empty-state" class="empty-state-bg rounded-lg shadow p-8 text-center hidden">
            <p class="text-lg mb-2">No universities shortlisted yet</p>
            <p class="text-sm">Go to the <a href="index.html" class="underline">Universities page</a> and click "+ Shortlist" on universities you want to apply to!</p>
        </div>

        <!-- Applications Table -->
        <div class="table-container rounded-lg shadow overflow-x-auto">
            <table class="w-full" id="applications-table" style="display: none;">
                <thead>
                    <tr>
                        <th class="text-left sortable" onclick="sortTable('university')">University</th>
                        <th class="text-left sortable" onclick="sortTable('country')" style="width: 50px;">Ctry</th>
                        <th class="text-left sortable" onclick="sortTable('program')" style="width: 150px;">Program</th>
                        <th class="text-left sortable" onclick="sortTable('cost')" style="width: 80px;">Cost</th>
                        <th class="text-left sortable" onclick="sortTable('status')" style="width: 110px;">Status</th>
                        <th class="text-left sortable" onclick="sortTable('deadline')" style="width: 110px;">Deadline</th>
                        <th class="text-left" style="min-width: 300px;">Notes / Next Steps</th>
                        <th class="text-center no-print" style="width: 50px;">Del</th>
                    </tr>
                </thead>
                <tbody id="applications-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script src="universities-data.js"></script>
    <script>
        let currentSort = { field: null, direction: 'asc' };

        function sortTable(field) {
            // Toggle direction if clicking same field
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }

            // Update header styling
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            const clickedHeader = event.target;
            clickedHeader.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');

            // Re-render with sorting
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            renderApplications(applications);
        }

        function loadData() {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            const unis = Object.keys(applications).map(id => parseInt(id));

            if (unis.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('applications-table').style.display = 'none';
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('applications-table').style.display = 'table';

            renderApplications(applications);
        }

        function renderApplications(applications) {
            const filterStatus = document.getElementById('filterStatus').value;
            const tbody = document.getElementById('applications-tbody');
            tbody.innerHTML = '';

            let total = 0, planning = 0, applied = 0, accepted = 0, rejected = 0;

            // Convert to array for sorting
            let entries = Object.entries(applications).map(([uniId, appData]) => {
                const uni = UNIVERSITIES_DATA.find(u => u.id === parseInt(uniId));
                return { uniId, appData, uni };
            }).filter(item => item.uni); // Remove entries where uni not found

            // Apply sorting
            if (currentSort.field) {
                entries.sort((a, b) => {
                    let aVal, bVal;

                    switch(currentSort.field) {
                        case 'university':
                            aVal = a.uni.name.toLowerCase();
                            bVal = b.uni.name.toLowerCase();
                            break;
                        case 'country':
                            aVal = a.uni.country.toLowerCase();
                            bVal = b.uni.country.toLowerCase();
                            break;
                        case 'program':
                            aVal = a.uni.program.toLowerCase();
                            bVal = b.uni.program.toLowerCase();
                            break;
                        case 'cost':
                            aVal = a.uni.costMin;
                            bVal = b.uni.costMin;
                            break;
                        case 'status':
                            aVal = a.appData.status;
                            bVal = b.appData.status;
                            break;
                        case 'deadline':
                            aVal = a.appData.deadline || '9999-12-31';
                            bVal = b.appData.deadline || '9999-12-31';
                            break;
                        default:
                            return 0;
                    }

                    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            entries.forEach(({uniId, appData, uni}) => {
                // Filter
                if (filterStatus !== 'all' && appData.status !== filterStatus) return;

                total++;
                if (appData.status === 'Planning') planning++;
                if (appData.status === 'Applied' || appData.status === 'Pending') applied++;
                if (appData.status === 'Accepted') accepted++;
                if (appData.status === 'Rejected') rejected++;

                // Country abbreviations
                const countryAbbr = {
                    'Germany': 'DE',
                    'Netherlands': 'NL',
                    'Belgium': 'BE',
                    'Spain': 'ES',
                    'France': 'FR',
                    'Austria': 'AT',
                    'Italy': 'IT',
                    'Sweden': 'SE',
                    'Portugal': 'PT'
                };

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="font-semibold">${uni.name}</div>
                        <div class="flex gap-2 mt-1">
                            <a href="${uni.url}" target="_blank" class="icon-btn" title="Visit Website">
                                üîó
                            </a>
                            ${uni.admissionsEmail ? `
                                <a href="mailto:${uni.admissionsEmail}" class="icon-btn" title="${uni.admissionsEmail}">
                                    üìß
                                </a>
                            ` : ''}
                        </div>
                    </td>
                    <td>
                        <span class="country-abbr">${countryAbbr[uni.country] || uni.country}</span>
                    </td>
                    <td>
                        <div class="program-text">${uni.program}</div>
                    </td>
                    <td class="font-semibold">${uni.cost}</td>
                    <td>
                        <select
                            class="status-select ${appData.status}"
                            onchange="updateStatus(${uni.id}, this.value)"
                        >
                            <option value="Planning" ${appData.status === 'Planning' ? 'selected' : ''}>üìã Planning</option>
                            <option value="Applied" ${appData.status === 'Applied' ? 'selected' : ''}>üì§ Applied</option>
                            <option value="Pending" ${appData.status === 'Pending' ? 'selected' : ''}>‚è≥ Pending</option>
                            <option value="Accepted" ${appData.status === 'Accepted' ? 'selected' : ''}>‚úÖ Accepted</option>
                            <option value="Rejected" ${appData.status === 'Rejected' ? 'selected' : ''}>‚ùå Rejected</option>
                        </select>
                    </td>
                    <td>
                        <input
                            type="date"
                            value="${appData.deadline || ''}"
                            onchange="updateDeadline(${uni.id}, this.value)"
                            class="rounded"
                        />
                    </td>
                    <td>
                        <textarea
                            onchange="updateNotes(${uni.id}, this.value)"
                            placeholder="Add notes..."
                            rows="2"
                            class="w-full px-2 py-1 rounded resize-y"
                        >${appData.notes || ''}</textarea>
                    </td>
                    <td class="text-center no-print">
                        <button
                            onclick="removeApplication(${uni.id})"
                            class="text-sm"
                            style="color: #f07178;"
                            title="Remove from shortlist"
                        >
                            ‚úï
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Update stats
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-planning').textContent = planning;
            document.getElementById('stat-applied').textContent = applied;
            document.getElementById('stat-accepted').textContent = accepted;
            document.getElementById('stat-rejected').textContent = rejected;
        }

        function updateStatus(uniId, status) {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            if (applications[uniId]) {
                applications[uniId].status = status;
                localStorage.setItem('universityApplications', JSON.stringify(applications));
                loadData(); // Reload to update styling
            }
        }

        function updateDeadline(uniId, deadline) {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            if (applications[uniId]) {
                applications[uniId].deadline = deadline;
                localStorage.setItem('universityApplications', JSON.stringify(applications));
            }
        }

        function updateNotes(uniId, notes) {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            if (applications[uniId]) {
                applications[uniId].notes = notes;
                localStorage.setItem('universityApplications', JSON.stringify(applications));
            }
        }

        function removeApplication(uniId) {
            if (!confirm('Remove this university from your application tracker?')) return;

            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            delete applications[uniId];
            localStorage.setItem('universityApplications', JSON.stringify(applications));
            loadData();
        }

        function exportToCSV() {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');

            let csv = 'University,Country,Program,Total Cost,Status,Deadline,Notes,Admissions Email,Website\n';

            Object.entries(applications).forEach(([uniId, appData]) => {
                const uni = UNIVERSITIES_DATA.find(u => u.id === parseInt(uniId));
                if (!uni) return;

                csv += `"${uni.name}","${uni.country}","${uni.program}","${uni.cost}","${appData.status}","${appData.deadline || ''}","${appData.notes || ''}","${uni.admissionsEmail || ''}","${uni.url}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `university-applications-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Event listeners
        document.getElementById('filterStatus').addEventListener('change', () => {
            const applications = JSON.parse(localStorage.getItem('universityApplications') || '{}');
            renderApplications(applications);
        });

        // Load data on page load
        loadData();

        // Reload when localStorage changes (from other tabs)
        window.addEventListener('storage', loadData);
    </script>
</body>
</html>
